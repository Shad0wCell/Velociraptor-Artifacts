name: PSList.VTLookup
description: |
   Combination of PSList with Virus Total reputation lookup using the Server Enrichment Artifact by Wes Lambert.

type: CLIENT

author: Chris Jones - CPIRT

parameters:
   - name: VirustotalKey
     default:

sources:
  - precondition:
      SELECT OS From info() where OS = 'windows' or 'linux'

  - query: |
        LET Creds = if(
           condition=VirustotalKey,
           then=VirustotalKey,
           else=server_metadata().VirustotalKey)
           
        LET Results = SELECT Name,Pid,Ppid,Username,{
            Select Name FROM pslist(pid=Ppid)
        } AS ParentName,hash(path=Exe).SHA1 AS SHA1,
        CommandLine, Exe FROM pslist()

        SELECT *, {SELECT VTRating FROM Artifact.Server.Enrichment.Virustotal(VirustotalKey=Creds,Hash=SHA1)} AS VTResults
        FROM foreach(row=Results)
