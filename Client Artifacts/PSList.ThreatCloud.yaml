name: PSList.ThreatCloud
description: |
   Combination of PSList with Check Point ThreatCloud reputation lookup using the Server Enrichment Artifact.
   Insert ThreatCloud API key into server metadata as ThreatCloudKey

type: CLIENT

author: Chris Jones - CPIRT

sources:
  - precondition:
      SELECT OS From info() where OS = 'windows' or 'linux'

    query: |
        LET Creds = server_metadata().ThreatCloudKey
        
        LET PSListQuery <= SELECT Name,Pid,Ppid,Username,hash(path=Exe).SHA256 AS SHA256,
        CommandLine, Exe FROM pslist()

        LET Rows = SELECT *, {SELECT ThreatCloudData.response.reputation.classification[0] AS Classification, 
        ThreatCloudData.response.reputation.severity[0] AS Severity, 
        ThreatCloudData.response.risk[0] AS Risk, 
        ThreatCloudData.response.findings.total[0] AS Total,
        ThreatCloudData.response.findings.positives[0] AS VTPositives
        FROM Artifact.Server.Enrichment.ThreatCloud.Hash(ThreatCloudKey=Creds,Hash=SHA256)} AS Data
        FROM foreach(row=PSListQuery)
        
        SELECT Name, Pid, Username, CommandLine, Exe, Data.Classification as Classifications, Data.Severity AS Severity, Data.Risk AS Risk, Data.Total AS Total, Data.VTPositives AS VTPositives
        FROM Rows
