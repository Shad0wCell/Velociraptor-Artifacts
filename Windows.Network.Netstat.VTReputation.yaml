name: Windows.Network.Netstat.VTReputation
description: |
  Show information about open sockets. On windows the time when the
  socket was first bound is also shown.

parameters:
   - name: VTKey
     default: VTKey

sources:
- precondition: SELECT OS From info() where OS = 'windows'
  query: |
    LET processes <= SELECT Name, Pid AS ProcPid FROM pslist()
    LET Results <= SELECT Pid, {
        SELECT Name from processes
        WHERE Pid = ProcPid
      } AS Name, FamilyString as Family,
      TypeString as Type,
      Status,
      Laddr.IP, Laddr.Port,
      Raddr.IP, Raddr.Port,
      Timestamp
    FROM netstat() WHERE NOT `Raddr.IP` =~ '''(^127\.0\.0\.1)|(^192\.168)|(^10\.)|(^172\.1[6-9])|(^172\.2[0-9])|(^172\.3[0-1])|(^0\.0\.0\.0)'''
    
    SELECT *, {SELECT VTRating FROM Server.Enrichment.VTIP(VirustotalKey=VTKey,IP=`Raddr.IP`)} AS VTResults
    FROM foreach(row=Results)
